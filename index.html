<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Retro Brick Maze</title>
    <style>
        /* GAYA RETRO & LAYOUT */
        body {
            background-color: #1a1a1a;
            color: #33ff00;
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            touch-action: none;
        }

        #game-container {
            position: relative;
            border: 4px solid #555;
            box-shadow: 0 0 25px rgba(0,0,0,0.9);
            background: #000;
            width: 320px;
            height: 240px;
        }

        canvas {
            width: 100%;
            height: 100%;
            image-rendering: pixelated; 
            display: block;
        }

        .scanlines {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.3) 50%, rgba(0,0,0,0.3));
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 10;
        }

        /* UI Overlay */
        #ui-layer {
            position: absolute;
            top: 5px; left: 5px; right: 5px;
            display: flex; justify-content: space-between;
            color: #33ff00; font-weight: bold;
            text-shadow: 1px 1px 0 #000;
            z-index: 5; font-size: 14px;
        }
        .status-msg { color: #fff; background: rgba(0,0,0,0.5); padding: 2px 5px; }

        #win-screen {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); color: #fff;
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 20; text-align: center;
        }

        button.restart-btn {
            margin-top: 15px; padding: 8px 15px; background: #33ff00; border: none;
            cursor: pointer; font-family: inherit; font-weight: bold; font-size: 16px;
        }

        /* KONTROL LAYAR */
        .controls-area {
            margin-top: 15px; display: flex; flex-direction: row; gap: 20px; align-items: center;
        }
        .d-pad { display: grid; grid-template-columns: 50px 50px 50px; grid-gap: 5px; }
        .btn {
            width: 50px; height: 50px; background: #333; border: 2px solid #555; color: #ddd;
            font-size: 20px; border-radius: 6px; display: flex; align-items: center; justify-content: center;
            user-select: none; cursor: pointer; -webkit-user-select: none;
        }
        .btn:active { background: #555; border-color: #888; }
        .btn-up { grid-column: 2; } .btn-left { grid-column: 1; grid-row: 2; }
        .btn-down { grid-column: 2; grid-row: 2; } .btn-right { grid-column: 3; grid-row: 2; }
        .btn-map {
            width: 70px; height: 70px; background: #004400; border: 2px solid #00aa00; color: #00ff00;
            border-radius: 50%; font-size: 14px; font-weight: bold; display: flex; align-items: center; justify-content: center; user-select: none;
        }
        .btn-map:active { background: #006600; }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="ui-layer">
            <span id="shield-count">TAMENG: 0/3</span>
            <span id="msg-area" class="status-msg">CARI 3 TAMENG!</span>
        </div>
        <canvas id="gameCanvas" width="320" height="240"></canvas>
        <div class="scanlines"></div>
        <div id="win-screen">
            <h2 style="color:#ffff00">MISI SUKSES!</h2>
            <p>Semua tameng terkumpul<br>dan berhasil keluar.</p>
            <button class="restart-btn" onclick="resetGame()">MAIN LAGI</button>
        </div>
    </div>

    <div class="controls-area">
        <div class="d-pad">
            <div class="btn btn-up" id="btnUp">▲</div>
            <div class="btn btn-left" id="btnLeft">◄</div>
            <div class="btn btn-down" id="btnDown">▼</div>
            <div class="btn btn-right" id="btnRight">►</div>
        </div>
        <div class="btn btn-map" id="btnMap">PETA</div>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const winScreen = document.getElementById('win-screen');
    const shieldUi = document.getElementById('shield-count');
    const msgArea = document.getElementById('msg-area');

    const SCREEN_WIDTH = 320;
    const SCREEN_HEIGHT = 240;
    const FOV = Math.PI / 3;
    const BLOCK_SIZE = 64;
    const MAP_SIZE = 16;
    const SPEED = 3.0; // Sedikit diperlambat agar tekstur terasa berat
    const ROT_SPEED = 0.07;
    const TOTAL_SHIELDS = 3;

    let map = [
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        [1,0,0,0,0,0,1,0,0,3,0,0,0,0,0,1],
        [1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],
        [1,0,1,0,0,0,1,0,0,0,1,0,0,1,0,1],
        [1,0,1,0,1,1,1,1,1,0,1,1,0,1,0,1],
        [1,0,0,0,0,0,0,0,0,0,0,0,0,1,3,1],
        [1,1,1,1,0,1,1,0,1,1,1,1,1,1,0,1],
        [1,3,0,1,0,1,0,0,0,0,0,0,0,0,0,1],
        [1,0,1,1,0,1,0,1,1,1,1,1,0,1,0,1],
        [1,0,0,0,0,1,0,1,2,0,0,0,0,1,0,1],
        [1,0,1,1,1,1,0,1,1,1,1,1,1,1,0,1],
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
    ];
    const originalMap = JSON.parse(JSON.stringify(map));

    let player = { x: BLOCK_SIZE * 1.5, y: BLOCK_SIZE * 1.5, dir: 0, shields: 0, won: false };
    let showMap = false;
    const keys = { up: false, down: false, left: false, right: false };

    // --- INPUT HANDLING (Sama seperti sebelumnya) ---
    document.addEventListener('keydown', (e) => {
        if(e.key === 'ArrowUp' || e.key === 'w') keys.up = true;
        if(e.key === 'ArrowDown' || e.key === 's') keys.down = true;
        if(e.key === 'ArrowLeft' || e.key === 'a') keys.left = true;
        if(e.key === 'ArrowRight' || e.key === 'd') keys.right = true;
        if(e.key === 'm' || e.key === 'M') showMap = true;
    });
    document.addEventListener('keyup', (e) => {
        if(e.key === 'ArrowUp' || e.key === 'w') keys.up = false;
        if(e.key === 'ArrowDown' || e.key === 's') keys.down = false;
        if(e.key === 'ArrowLeft' || e.key === 'a') keys.left = false;
        if(e.key === 'ArrowRight' || e.key === 'd') keys.right = false;
        if(e.key === 'm' || e.key === 'M') showMap = false;
    });
    const bindTouch = (id, key, isMap = false) => {
        const el = document.getElementById(id);
        const start = (e) => { e.preventDefault(); if(isMap) showMap = true; else keys[key] = true; el.style.opacity = '0.5'; };
        const end = (e) => { e.preventDefault(); if(isMap) showMap = false; else keys[key] = false; el.style.opacity = '1'; };
        el.addEventListener('mousedown', start); el.addEventListener('mouseup', end);
        el.addEventListener('touchstart', start); el.addEventListener('touchend', end);
    };
    bindTouch('btnUp', 'up'); bindTouch('btnDown', 'down'); bindTouch('btnLeft', 'left'); bindTouch('btnRight', 'right'); bindTouch('btnMap', 'map', true);

    // --- UPDATE LOGIC (Sama seperti sebelumnya) ---
    function update() {
        if (player.won) return;
        if (keys.left) player.dir -= ROT_SPEED;
        if (keys.right) player.dir += ROT_SPEED;
        let moveStep = 0;
        if (keys.up) moveStep = SPEED;
        if (keys.down) moveStep = -SPEED;
        let newX = player.x + Math.cos(player.dir) * moveStep;
        let newY = player.y + Math.sin(player.dir) * moveStep;
        const gridX = Math.floor(newX / BLOCK_SIZE);
        const gridY = Math.floor(newY / BLOCK_SIZE);
        let targetBlock = map[gridY][gridX];

        if (targetBlock !== 1) {
            player.x = newX; player.y = newY;
            if (targetBlock === 3) {
                map[gridY][gridX] = 0; player.shields++;
                shieldUi.innerText = `TAMENG: ${player.shields}/${TOTAL_SHIELDS}`;
                msgArea.innerText = "DAPAT TAMENG!"; msgArea.style.color = "#ffff00";
                setTimeout(() => { msgArea.innerText = player.shields === TOTAL_SHIELDS ? "CARI PINTU KELUAR!" : "CARI LAGI..."; msgArea.style.color = "#fff"; }, 2000);
            }
            if (targetBlock === 2) {
                if (player.shields >= TOTAL_SHIELDS) { player.won = true; winScreen.style.display = 'flex'; } 
                else { msgArea.innerText = "KUNCI: BUTUH 3 TAMENG!"; msgArea.style.color = "#ff3333"; }
            }
        }
    }

    // --- RAYCASTING DENGAN TEKSTUR BATA PROSEDURAL ---
    function castRays() {
        // Langit (Lebih gelap) & Lantai (Abu-abu tua)
        ctx.fillStyle = "#050505"; ctx.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT / 2);
        ctx.fillStyle = "#2a2a2a"; ctx.fillRect(0, SCREEN_HEIGHT / 2, SCREEN_WIDTH, SCREEN_HEIGHT / 2);

        for (let x = 0; x < SCREEN_WIDTH; x+=2) { // Resolusi horizontal 2px
            const rayAngle = (player.dir - FOV / 2.0) + (x / SCREEN_WIDTH) * FOV;
            const eyeX = Math.cos(rayAngle);
            const eyeY = Math.sin(rayAngle);

            let distToWall = 0; let hitWall = false; let blockType = 0; let side = 0;
            let testX = Math.floor(player.x / BLOCK_SIZE);
            let testY = Math.floor(player.y / BLOCK_SIZE);
            let stepX = Math.sign(eyeX); let stepY = Math.sign(eyeY);
            let sideDistX = (stepX < 0 ? player.x - testX * BLOCK_SIZE : (testX + 1) * BLOCK_SIZE - player.x) / Math.abs(eyeX);
            let sideDistY = (stepY < 0 ? player.y - testY * BLOCK_SIZE : (testY + 1) * BLOCK_SIZE - player.y) / Math.abs(eyeY);
            let deltaDistX = BLOCK_SIZE / Math.abs(eyeX);
            let deltaDistY = BLOCK_SIZE / Math.abs(eyeY);

            while (!hitWall && distToWall < 20 * BLOCK_SIZE) {
                if (sideDistX < sideDistY) {
                    sideDistX += deltaDistX; testX += stepX; distToWall = (Math.abs((testX * BLOCK_SIZE - player.x + (1 - stepX) * BLOCK_SIZE / 2) / eyeX));
                    side = 0; // Hit tembok vertikal
                } else {
                    sideDistY += deltaDistY; testY += stepY; distToWall = (Math.abs((testY * BLOCK_SIZE - player.y + (1 - stepY) * BLOCK_SIZE / 2) / eyeY));
                    side = 1; // Hit tembok horizontal
                }
                if (testX < 0 || testX >= MAP_SIZE || testY < 0 || testY >= MAP_SIZE) { hitWall = true; distToWall = 20 * BLOCK_SIZE; } 
                else if (map[testY][testX] > 0) { hitWall = true; blockType = map[testY][testX]; }
            }

            let correctDist = distToWall * Math.cos(rayAngle - player.dir);
            let ceiling = Math.floor(SCREEN_HEIGHT / 2.0 - SCREEN_HEIGHT / correctDist * BLOCK_SIZE / 2);
            let floor = SCREEN_HEIGHT - ceiling;
            let wallHeight = floor - ceiling;

            // --- LOGIKA TEKSTUR ---
            // Hitung posisi X tepatnya di mana sinar menabrak tembok (0.0 - 1.0)
            let wallX; 
            if (side === 0) wallX = player.y + distToWall * eyeY;
            else            wallX = player.x + distToWall * eyeX;
            wallX -= Math.floor(wallX);
            
            // Koordinat X tekstur (0 - 63)
            let texX = Math.floor(wallX * BLOCK_SIZE);
            if(side === 0 && eyeX > 0) texX = BLOCK_SIZE - texX - 1;
            if(side === 1 && eyeY < 0) texX = BLOCK_SIZE - texX - 1;

            // Loop vertikal untuk menggambar pixel demi pixel (untuk tekstur)
            // Kita gambar 2 pixel sekaligus vertikal untuk performa
            for (let y = ceiling; y < floor; y+=2) {
                // Hitung koordinat Y tekstur berdasarkan perspektif
                let d = y * 256 - SCREEN_HEIGHT * 128 + wallHeight * 128;
                let texY = ((d * BLOCK_SIZE) / wallHeight) / 256;
                texY = Math.floor(texY) & (BLOCK_SIZE - 1);

                let colorR, colorG, colorB;

                // --- GENERATE POLA BATA ---
                if (blockType === 1) { // Tembok Bata Merah
                    const brickH = 8; // Tinggi bata
                    const brickW = 32; // Lebar bata
                    const mortarThickness = 2;

                    let isMortar = false;
                    // Cek garis semen horizontal
                    if (texY % brickH < mortarThickness) isMortar = true;
                    // Cek garis semen vertikal (dengan offset setiap baris)
                    let offsetX = (Math.floor(texY / brickH) % 2 === 0) ? 0 : brickW / 2;
                    if ((texX + offsetX) % brickW < mortarThickness) isMortar = true;

                    if (isMortar) {
                         colorR = 100; colorG = 100; colorB = 100; // Abu-abu semen
                    } else {
                         colorR = 180; colorG = 60; colorB = 40; // Merah bata
                    }
                     // Sisi tembok yang berbeda sedikit lebih gelap
                    if(side === 1) { colorR*=0.8; colorG*=0.8; colorB*=0.8; }

                } else if (blockType === 2) { // Pintu Merah (Solid)
                    colorR = 200; colorG = 0; colorB = 0;
                } else if (blockType === 3) { // Tameng Emas (Solid)
                    colorR = 200; colorG = 200; colorB = 0;
                }

                // SHADING (Semakin jauh semakin gelap)
                let shade = 1.0 - (correctDist / (MAP_SIZE * BLOCK_SIZE * 0.8));
                if(shade < 0.1) shade = 0.1;
                
                // Terapkan shading ke warna
                ctx.fillStyle = `rgb(${colorR * shade}, ${colorG * shade}, ${colorB * shade})`;
                // Gambar pixel (lebar 2, tinggi 2)
                ctx.fillRect(x, y, 2, 2);
            }
        }
    }

    function drawMinimap() {
        if (!showMap) return;
        const scale = 8; const w = MAP_SIZE * scale; const h = MAP_SIZE * scale;
        const offsetX = (SCREEN_WIDTH - w) / 2; const offsetY = (SCREEN_HEIGHT - h) / 2;
        ctx.fillStyle = "rgba(0, 0, 0, 0.8)"; ctx.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);
        ctx.strokeStyle = "#33ff00"; ctx.lineWidth = 2; ctx.strokeRect(offsetX, offsetY, w, h);
        for (let y = 0; y < MAP_SIZE; y++) {
            for (let x = 0; x < MAP_SIZE; x++) {
                let val = map[y][x];
                if (val === 1) ctx.fillStyle = "#a33"; // Bata di peta jadi merah tua
                else if (val === 2) ctx.fillStyle = "#f00"; else if (val === 3) ctx.fillStyle = "#ff0"; else ctx.fillStyle = "#111";
                ctx.fillRect(offsetX + x * scale, offsetY + y * scale, scale, scale);
            }
        }
        ctx.fillStyle = "#fff"; ctx.beginPath();
        ctx.arc(offsetX + (player.x / BLOCK_SIZE) * scale, offsetY + (player.y / BLOCK_SIZE) * scale, 3, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "#fff"; ctx.font = "16px Courier"; ctx.textAlign = "center"; ctx.fillText("PETA RAHASIA", SCREEN_WIDTH/2, offsetY - 10);
    }

    function gameLoop() {
        update(); castRays(); drawMinimap(); requestAnimationFrame(gameLoop);
    }
    function resetGame() {
        map = JSON.parse(JSON.stringify(originalMap));
        player = { x: BLOCK_SIZE * 1.5, y: BLOCK_SIZE * 1.5, dir: 0, shields: 0, won: false };
        shieldUi.innerText = "TAMENG: 0/3"; msgArea.innerText = "CARI 3 TAMENG!"; msgArea.style.color = "#fff";
        winScreen.style.display = 'none'; showMap = false;
    }
    gameLoop();
</script>
</body>
</html>
